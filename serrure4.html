<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Terminal Serrure Arduino</title>
    <style>
        /* --- VOTRE DESIGN DE BASE --- */
        body { font-family: 'Courier New', Courier, monospace; background-color: #1e1e1e; color: #00ff00; padding: 20px; }
        h1 { text-align: center; color: white; border-bottom: 2px solid #00ff00; padding-bottom: 10px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* Bouton Connexion */
        #btnConnect { 
            display: block; width: 100%; padding: 15px; font-size: 18px; font-weight: bold;
            background: #333; color: white; border: 2px solid #555; cursor: pointer; margin-bottom: 20px;
            font-family: inherit; transition: 0.3s;
        }
        #btnConnect:hover { background: #00ff00; color: #000; border-color: #00ff00; }

        /* Zone Status */
        #status-box {
            padding: 20px; border: 2px solid #555; margin-bottom: 20px; text-align: center; 
            font-size: 24px; font-weight: bold; background: #000;
        }
        .ok { color: #000; background-color: #00ff00 !important; border-color: #00ff00 !important; }
        .error { color: #fff; background-color: #ff0000 !important; border-color: red !important; animation: shake 0.5s; }
        .wait { color: #ffff00; border-color: #ffff00 !important; }

        /* --- NOUVELLE ZONE DE COMMANDE (GRID) --- */
        .control-panel {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            opacity: 0.5; pointer-events: none; /* D√©sactiv√© tant que pas connect√© */
            transition: opacity 0.5s; margin-bottom: 20px;
        }

        /* 1. Style du Clavier Virtuel */
        .panel-box { border: 1px solid #333; padding: 15px; background: #111; }
        .panel-title { text-align: center; border-bottom: 1px solid #333; margin-bottom: 10px; color: #888; }
        
        #virtual-screen {
            background: #000; border: 1px solid #00ff00; color: #00ff00;
            height: 40px; line-height: 40px; text-align: center; font-size: 24px; letter-spacing: 5px; margin-bottom: 10px;
        }
        .keys-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .key-btn {
            background: #000; border: 1px solid #004400; color: #00ff00; 
            padding: 15px; font-size: 18px; cursor: pointer; font-family: inherit;
        }
        .key-btn:active { background: #00ff00; color: #000; }
        .key-action { border-color: #00ff00; font-weight: bold; }
        .key-clear { color: #ff3333; border-color: #550000; }

        /* 2. Style Admin (Base de donn√©e) */
        .admin-input {
            width: 80%; padding: 10px; background: #000; border: 1px solid #00ff00; color: #00ff00;
            font-family: inherit; font-size: 20px; text-align: center; margin-bottom: 10px; display: block; margin: 0 auto 10px auto;
        }
        .admin-btn {
            width: 100%; padding: 10px; background: #003300; color: #00ff00; border: 1px solid #00ff00;
            cursor: pointer; font-family: inherit; font-weight: bold;
        }
        .admin-btn:hover { background: #00ff00; color: #000; }

        /* Logs */
        #log-container { background: #111; border: 1px solid #333; height: 200px; overflow-y: scroll; padding: 10px; font-size: 14px; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #222; }
        .time { color: #666; font-size: 0.8em; margin-right: 10px; }

        /* Animation secousse */
        @keyframes shake {
            0% { transform: translate(1px, 1px); } 10% { transform: translate(-1px, -2px); }
            20% { transform: translate(-3px, 0px); } 30% { transform: translate(3px, 2px); }
            40% { transform: translate(1px, -1px); } 100% { transform: translate(0, 0); }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üîê TERMINAL SERRURE V3.0</h1>
        
        <button id="btnConnect">üîå ACTIVER LA SURVEILLANCE USB</button>

        <div id="status-box">EN ATTENTE DE CONNEXION...</div>

        <div class="control-panel" id="controls">
            
            <div class="panel-box">
                <div class="panel-title">// ACCES VIRTUEL //</div>
                <div id="virtual-screen">----</div>
                <div class="keys-grid">
                    <button class="key-btn" onclick="tap('1')">1</button>
                    <button class="key-btn" onclick="tap('2')">2</button>
                    <button class="key-btn" onclick="tap('3')">3</button>
                    <button class="key-btn" onclick="tap('4')">4</button>
                    <button class="key-btn" onclick="tap('5')">5</button>
                    <button class="key-btn" onclick="tap('6')">6</button>
                    <button class="key-btn" onclick="tap('7')">7</button>
                    <button class="key-btn" onclick="tap('8')">8</button>
                    <button class="key-btn" onclick="tap('9')">9</button>
                    <button class="key-btn key-clear" onclick="clearTap()">C</button>
                    <button class="key-btn" onclick="tap('0')">0</button>
                    <button class="key-btn key-action" onclick="sendCode()">OK</button>
                </div>
            </div>

            <div class="panel-box">
                <div class="panel-title">// CONFIGURATION EEPROM //</div>
                <p style="text-align:center; font-size:0.9em; color:#aaa;">Nouveau code (4 chiffres) :</p>
                <input type="text" id="dbInput" class="admin-input" maxlength="4" placeholder="XXXX">
                <button class="admin-btn" onclick="updateDatabase()">üíæ SAUVEGARDER LE CODE</button>
                <div id="admin-msg" style="text-align:center; margin-top:10px; color:#aaa; font-size:0.8em;">...</div>
            </div>

        </div>

        <h3>Historique :</h3>
        <div id="log-container"></div>
    </div>

    <script>
        let port, writer, reader;
        let currentInput = "";
        const statusBox = document.getElementById('status-box');
        
        // --- 1. FONCTIONS DU CLAVIER VIRTUEL ---
        function tap(num) {
            if (currentInput.length < 4) {
                currentInput += num;
                document.getElementById('virtual-screen').innerText = currentInput.padEnd(4, '-');
            }
        }
        function clearTap() {
            currentInput = "";
            document.getElementById('virtual-screen').innerText = "----";
        }
        async function sendCode() {
            if (currentInput.length === 4) {
                addToLog("Envoi tentative web : " + currentInput);
                await sendToArduino("CHECK:" + currentInput);
                clearTap();
            }
        }

        // --- 2. FONCTION BASE DE DONNEES ---
        async function updateDatabase() {
            let code = document.getElementById('dbInput').value;
            if (code.length === 4 && !isNaN(code)) {
                addToLog("Demande de changement de code...");
                await sendToArduino("SET:" + code);
                document.getElementById('dbInput').value = "";
            } else {
                alert("Erreur : Le code doit faire exactement 4 chiffres.");
            }
        }

        // --- 3. CONNEXION USB (Web Serial API) ---
        document.getElementById('btnConnect').addEventListener('click', async () => {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                
                // Pr√©paration flux
                const textEncoder = new TextEncoderStream();
                const writableStreamClosed = textEncoder.readable.pipeTo(port.writable);
                writer = textEncoder.writable.getWriter();
                const textDecoder = new TextDecoderStream();
                const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
                reader = textDecoder.readable.getReader();

                // Interface Active
                document.getElementById('btnConnect').style.display = 'none';
                updateStatus("SYSTEME CONNECT√â", "wait");
                
                // D√©verrouille les contr√¥les
                document.getElementById('controls').style.opacity = "1";
                document.getElementById('controls').style.pointerEvents = "auto";

                listenLoop();
            } catch (e) { alert("Erreur : " + e); }
        });

        async function sendToArduino(msg) {
            if (writer) await writer.write(msg + "\n");
        }

        async function listenLoop() {
            let buffer = "";
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += value;
                let lines = buffer.split('\n');
                buffer = lines.pop();
                for (let line of lines) traiterMessage(line.trim());
            }
        }

        function traiterMessage(msg) {
            if (!msg) return;
            addToLog("Arduino : " + msg); // Affiche tout dans les logs pour debug

            // R√©actions visuelles selon les messages re√ßus de l'Arduino
            if (msg.includes("RESULT:SUCCESS") || msg.includes("Acc√®s autoris√©")) {
                updateStatus("üîì ACCES AUTORIS√â", "ok");
                setTimeout(() => updateStatus("üõ°Ô∏è SYSTEME PRET", "wait"), 3000);
            } 
            else if (msg.includes("RESULT:FAIL") || msg.includes("Code incorrect")) {
                updateStatus("‚õî CODE REFUS√â", "error");
                setTimeout(() => updateStatus("üõ°Ô∏è SYSTEME PRET", "wait"), 2000);
            }
            else if (msg.includes("RESULT:LOCKED") || msg.includes("Serrure bloqu√©e")) {
                updateStatus("‚ö†Ô∏è ALARME : BLOCAGE", "error");
            }
            else if (msg.includes("SUCCESS:CODE_UPDATED")) {
                document.getElementById('admin-msg').innerText = "‚úÖ Code mis √† jour avec succ√®s !";
                setTimeout(() => document.getElementById('admin-msg').innerText = "...", 3000);
            }
        }

        function updateStatus(text, className) {
            statusBox.innerText = text;
            statusBox.className = ""; 
            if (className) statusBox.classList.add(className);
        }

        function addToLog(text) {
            const div = document.createElement('div');
            div.className = "log-entry";
            div.innerHTML = `<span class="time">[${new Date().toLocaleTimeString()}]</span> ${text}`;
            document.getElementById('log-container').prepend(div);
        }
    </script>
</body>
</html>